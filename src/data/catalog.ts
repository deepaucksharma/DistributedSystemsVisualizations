import type { ScenarioMeta } from '../types/scenario';

export const SCENARIO_CATALOG: ScenarioMeta[] = [
  {
    id: 'happy-path',
    title: 'Happy Path',
    description: 'Write → Replicate → Commit → Read. The baseline with no failures.',
    traceFile: 'happy-path',
    frameworkRefs: ['§2.1-2.5', '§3.2', '§4.1', '§4.5'],
    geometries: ['safety', 'observation'],
    tier: 1,
    compareWith: 'figure-8',
  },
  {
    id: 'figure-8',
    title: 'Figure-8: Coupling Violation',
    description: 'Why commit certificates must be monotone in (Epoch, Index), not just Index.',
    traceFile: 'figure-8',
    frameworkRefs: ['§4.3 Coupling Law', '§2.3 History Tree'],
    geometries: ['safety', 'authority', 'coupling', 'failure'],
    tier: 1,
    bugClass: 'phantom_commit',
    compareWith: 'happy-path',
  },
  {
    id: 'split-brain',
    title: 'Split Brain',
    description: 'A buggy sub-quorum election grants authority without quorum intersection, enabling two simultaneous leaders.',
    traceFile: 'split-brain',
    frameworkRefs: ['§4.2 Authority', '§7.2'],
    geometries: ['authority', 'failure'],
    tier: 1,
    bugClass: 'split_brain',
    dependsOn: ['happy-path'],
  },
  {
    id: 'trim-cliff',
    title: 'Trim Cliff',
    description: 'A lagging replica falls behind the trim frontier.',
    traceFile: 'trim-cliff',
    frameworkRefs: ['§2.5', '§4.4'],
    geometries: ['resource'],
    tier: 1,
    bugClass: 'trim_cliff',
    dependsOn: ['happy-path'],
    compareWith: 'snapshot-install',
  },
  {
    id: 'snapshot-install',
    title: 'Snapshot Install',
    description: 'Recovering a replica that has fallen behind the trim frontier.',
    traceFile: 'snapshot-install',
    frameworkRefs: ['§4.4'],
    geometries: ['resource'],
    tier: 1,
    dependsOn: ['trim-cliff'],
    compareWith: 'trim-cliff',
  },
  {
    id: 'stale-read',
    title: 'Stale Read',
    description: 'Follower read vs linearizable read — what clients see.',
    traceFile: 'stale-read',
    frameworkRefs: ['§4.5', '§3.2 read cert'],
    geometries: ['observation'],
    tier: 1,
    bugClass: 'read_anomaly',
    dependsOn: ['happy-path'],
  },
  // ── Tier 2: Extended Scenarios ──
  {
    id: 'zombie-side-effect',
    title: 'Zombie Side Effect',
    description: 'Old leader re-sends external side effect after crash recovery — duplicate payment.',
    traceFile: 'zombie-side-effect',
    frameworkRefs: ['§5.4 Composition Geometry', '§3.2 Externalization Certificate'],
    geometries: ['composition', 'authority', 'failure'],
    tier: 2,
    bugClass: 'zombie_side_effect',
    dependsOn: ['happy-path'],
  },
  {
    id: 'unsafe-reconfig',
    title: 'Unsafe Reconfiguration',
    description: 'Direct config swap creates disjoint quorums — split brain across configurations.',
    traceFile: 'unsafe-reconfig',
    frameworkRefs: ['§5.2 Membership Geometry', '§7.2 reconfig_split_brain'],
    geometries: ['membership', 'authority', 'safety'],
    tier: 2,
    bugClass: 'reconfig_split_brain',
    dependsOn: ['split-brain'],
    compareWith: 'safe-reconfig',
  },
  {
    id: 'safe-reconfig',
    title: 'Safe Reconfiguration',
    description: 'Joint consensus ensures quorum overlap during config transitions.',
    traceFile: 'safe-reconfig',
    frameworkRefs: ['§5.2 Membership Geometry'],
    geometries: ['membership', 'authority', 'safety'],
    tier: 2,
    dependsOn: ['unsafe-reconfig'],
    compareWith: 'unsafe-reconfig',
  },
  {
    id: 'election-storm',
    title: 'Election Storm',
    description: 'Multiple candidates keep interrupting elections — safety preserved but liveness fails (FLP).',
    traceFile: 'election-storm',
    frameworkRefs: ['§6.1 FLP Impossibility', '§6.2 Failure Detectors'],
    geometries: ['liveness', 'authority'],
    tier: 2,
    bugClass: 'election_storm',
    dependsOn: ['happy-path'],
  },
  {
    id: 'cross-shard-txn',
    title: 'Cross-Shard Transaction',
    description: 'Two-phase commit across shards with transaction certificates.',
    traceFile: 'cross-shard-txn',
    frameworkRefs: ['§5.1 Ownership Geometry', '§5.4 Composition'],
    geometries: ['ownership', 'composition', 'safety'],
    tier: 2,
    dependsOn: ['happy-path'],
  },
  {
    id: 'data-loss-after-ack',
    title: 'Data Loss After Ack (fsync Lie)',
    description: 'Replica acks as durable without fsync — committed data lost on crash.',
    traceFile: 'data-loss-after-ack',
    frameworkRefs: ['§5.5 Failure Geometry', '§3.1 Durability Boundary'],
    geometries: ['failure', 'safety'],
    tier: 2,
    bugClass: 'fsync_lie',
    dependsOn: ['happy-path'],
  },
  // ── Tier 3: DAG / CRDT ──
  {
    id: 'crdt-convergence',
    title: 'CRDT Convergence',
    description: 'Grow-Only Set converges across partitions without consensus — CALM in action.',
    traceFile: 'crdt-convergence',
    frameworkRefs: ['§5.3 CALM Theorem', '§2.1 History Shape', '§2.2 Partial Order'],
    geometries: ['causality', 'observation'],
    tier: 3,
    compareWith: 'coordination-cut',
  },
  {
    id: 'coordination-cut',
    title: 'Coordination Cut',
    description: 'Hybrid architecture: monotone ops run coordination-free, non-monotone invariants need consensus.',
    traceFile: 'coordination-cut',
    frameworkRefs: ['§5.3 CALM (inverse)', '§4.3 Coupling Law', '§5.1 Ownership'],
    geometries: ['causality', 'authority', 'composition'],
    tier: 3,
    dependsOn: ['crdt-convergence'],
    compareWith: 'crdt-convergence',
  },
];

// Helper to get scenarios available (those whose trace files exist)
const AVAILABLE_TRACES = new Set([
  'happy-path', 'figure-8', 'split-brain', 'trim-cliff', 'snapshot-install', 'stale-read',
  'zombie-side-effect', 'unsafe-reconfig', 'safe-reconfig', 'election-storm', 'cross-shard-txn', 'data-loss-after-ack',
  'crdt-convergence', 'coordination-cut',
]);

export function getAvailableScenarios(): ScenarioMeta[] {
  return SCENARIO_CATALOG.filter((s) => AVAILABLE_TRACES.has(s.traceFile));
}

export function getScenarioById(id: string): ScenarioMeta | undefined {
  return SCENARIO_CATALOG.find((s) => s.id === id);
}
